<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hope's Compass - Mentorship Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f4f8;
      background-image: url('https://cdn.pixabay.com/photo/2017/08/30/01/05/milky-way-2695569_1280.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
    }
    .card {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      background-color: rgba(255, 255, 255, 0.92);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .tab.active {
      color: #3b82f6;
      border-bottom: 3px solid #3b82f6;
    }
    .chat-message {
      border-radius: 1rem;
      max-width: 80%;
    }
    .sent {
      background-color: #3b82f6;
      color: white;
      margin-left: auto;
    }
    .received {
      background-color: #e5e7eb;
      color: #1f2937;
    }
    .loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .spinner {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from {transform: rotate(0deg);}
      to {transform: rotate(360deg);}
    }
        .resource-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background-color: #f9fafb;
      border-radius: 0.5rem;
      border-left: 4px solid #3b82f6;
    }
    .resource-section h4 {
      color: #1f2937;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .resource-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .resource-section li {
      margin-bottom: 0.75rem;
      padding-left: 1.5rem;
      position: relative;
    }
    .resource-section li:before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
    }
    .resource-section a {
      color: #3b82f6 !important;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }
    .resource-section a:hover {
      color: #1d4ed8 !important;
      text-decoration: underline;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body class="bg-gray-100">
  <div id="app" class="min-h-screen flex items-center justify-center py-6 px-4 max-w-5xl mx-auto w-full">
    <!-- Authentication Card -->
    <div id="auth-card" class="card w-full max-w-md p-6 rounded-lg">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-blue-600">Hope's Compass</h1>
        <p class="text-gray-600 mt-2">Connecting teens through shared journeys</p>
      </div>

      <!-- Auth Tabs -->
      <div class="flex mb-6 border-b">
        <button
          id="signin-tab"
          class="auth-tab flex-1 py-2 text-center font-medium text-gray-700 border-b-2 border-blue-500"
        >
          Sign In
        </button>
        <button
          id="signup-tab"
          class="auth-tab flex-1 py-2 text-center font-medium text-gray-500"
        >
          Sign Up
        </button>
      </div>

      <!-- Sign In Form -->
      <form id="signin-form" class="auth-form">
        <div class="mb-4">
          <label for="signin-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input
            type="email"
            id="signin-email"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
          <p class="error-message text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <div class="mb-6">
          <label for="signin-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input
            type="password"
            id="signin-password"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
          <p class="error-message text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <button
          type="submit"
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-200"
        >
          Sign In
        </button>
      </form>

      <!-- Sign Up Form -->
      <form id="signup-form" class="auth-form hidden">
        <div class="mb-4">
          <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input
            type="email"
            id="signup-email"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
          <p class="error-message text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <div class="mb-4">
          <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input
            type="password"
            id="signup-password"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
          <p class="error-message text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <div class="mb-6">
          <label for="role" class="block text-sm font-medium text-gray-700 mb-1">I am a:</label>
          <select
            id="role"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="" disabled selected>Select your role</option>
            <option value="mentee">Mentee (seeking guidance)</option>
            <option value="mentor">Mentor (offering support)</option>
          </select>
          <p class="error-message text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <button
          type="submit"
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-200"
        >
          Sign Up
        </button>
      </form>
    </div>

    <!-- Onboarding Card -->
    <div id="onboarding-card" class="card w-full max-w-md p-6 rounded-lg hidden">
      <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-blue-600">Complete Your Profile</h2>
        <p class="text-gray-600 mt-1">Help us match you with the right people</p>
      </div>

      <form id="onboarding-form">
        <div class="mb-4">
          <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Age</label>
          <input
            type="number"
            id="age"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
          <p class="error-message text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <div class="mb-4">
          <label for="cancer-type" class="block text-sm font-medium text-gray-700 mb-1">Cancer Type</label>
          <input
            type="text"
            id="cancer-type"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
          <p class="error-message text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <div class="mb-4">
          <label for="treatment-stage" class="block text-sm font-medium text-gray-700 mb-1">Treatment Stage</label>
          <select
            id="treatment-stage"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="" disabled selected>Select your treatment stage</option>
            <option value="newly-diagnosed">Newly Diagnosed</option>
            <option value="active-treatment">Active Treatment</option>
            <option value="post-treatment">Post Treatment</option>
            <option value="remission">Remission</option>
          </select>
          <p class="error-message text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <div class="mb-6">
          <label for="interests" class="block text-sm font-medium text-gray-700 mb-1">Personal Interests (comma-separated)</label>
          <input
            type="text"
            id="interests"
            placeholder="e.g., music, reading, gaming"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
          <p class="error-message text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <button
          type="submit"
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-200"
        >
          Complete Profile
        </button>
      </form>
    </div>

    <!-- Main Portal -->
    <div id="portal" class="hidden w-full max-w-4xl flex flex-col">
      <!-- Top Bar -->
      <div
        class="bg-white shadow-md p-4 rounded-t-lg flex justify-between items-center"
      >
        <h1 class="text-2xl font-bold text-blue-600">Hope's Compass</h1>
        <button
          id="logout-btn"
          class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md transition duration-200"
        >
          <i class="fas fa-sign-out-alt mr-2"></i>Log Out
        </button>
      </div>

      <!-- Tabs -->
      <div class="bg-white border-b flex">
        <button
          data-tab="profile"
          class="tab active flex-1 py-3 text-center font-medium"
        >
          <i class="fas fa-user mr-2"></i>Profile
        </button>
        <button
          data-tab="chat"
          class="tab flex-1 py-3 text-center font-medium text-gray-500"
        >
          <i class="fas fa-comments mr-2"></i>Chat
        </button>
        <button
          data-tab="resources"
          class="tab flex-1 py-3 text-center font-medium text-gray-500"
        >
          <i class="fas fa-book-medical mr-2"></i>Resources
        </button>
        <button
          data-tab="important-dates"
          class="tab flex-1 py-3 text-center font-medium text-gray-500"
        >
          <i class="fas fa-flag-checkered mr-2"></i>Important Dates
        </button>
        <button
          data-tab="matches"
          class="tab flex-1 py-3 text-center font-medium text-gray-500"
        >
          <i class="fas fa-handshake mr-2"></i>Matches
        </button>
      </div>

      <!-- Tab Content -->
      <div
        class="bg-white p-6 rounded-b-lg shadow-md flex-grow overflow-auto"
      >
        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content active">
          <h2 class="text-xl font-bold mb-4">Your Profile</h2>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <div>
                <span class="text-sm font-medium text-gray-500">Email:</span>
                <p id="profile-email" class="text-gray-800"></p>
              </div>

              <div>
                <span class="text-sm font-medium text-gray-500">Role:</span>
                <p id="profile-role" class="text-gray-800"></p>
              </div>

              <div>
                <span class="text-sm font-medium text-gray-500">Age:</span>
                <p id="profile-age" class="text-gray-800"></p>
              </div>
            </div>

            <div class="space-y-3">
              <div>
                <span class="text-sm font-medium text-gray-500">Cancer Type:</span>
                <p id="profile-cancer-type" class="text-gray-800"></p>
              </div>

              <div>
                <span class="text-sm font-medium text-gray-500"
                  >Treatment Stage:</span
                >
                <p id="profile-treatment-stage" class="text-gray-800"></p>
              </div>

              <div>
                <span class="text-sm font-medium text-gray-500">Interests:</span>
                <p id="profile-interests" class="text-gray-800"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Tab -->
        <div id="chat-tab" class="tab-content">
          <h2 class="text-xl font-bold mb-4">Conversations</h2>

          <div class="border rounded-lg overflow-hidden flex flex-col h-[320px]">
            <div
              id="chat-history"
              class="p-4 flex-grow overflow-y-auto bg-gray-50 space-y-4"
            >
              <!-- Chat messages will be inserted here -->
            </div>

            <div class="border-t p-3 bg-white">
              <form id="chat-form" class="flex">
                <input
                  type="text"
                  id="chat-input"
                  placeholder="Type your message..."
                  class="flex-grow px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
                <button
                  type="submit"
                  class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r-md transition duration-200"
                >
                  <i class="fas fa-paper-plane"></i>
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Resources Tab -->
        <div id="resources-tab" class="tab-content">
          <h2 class="text-xl font-bold mb-4">Resources</h2>
          
          <p class="text-gray-600 mb-6">Below are curated resources by cancer type, tailored for teens undergoing chemotherapy and their mentors.</p>

          <div class="resource-section">
          
            <h4><b>General Cancer Support & Resources</b></h4>
            <ul>
              <li><a href="https://www.cancer.org/" target="_blank" rel="noopener noreferrer">American Cancer Society</a></li>
              <li><a href="https://www.stjude.org/" target="_blank" rel="noopener noreferrer">St. Jude Children's Research Hospital</a></li>
              <li><a href="https://teenagecancertrust.org/" target="_blank" rel="noopener noreferrer">Teenage Cancer Trust</a></li>
              <li><a href="https://www.cancercare.org/" target="_blank" rel="noopener noreferrer">CancerCare - Support Services</a></li>
              <li><a href="https://www.cancer.net/coping-younger-adults" target="_blank" rel="noopener noreferrer">Cancer.Net - Coping for Young Adults</a></li>
              <li><a href="https://www.youngsurvival.org/" target="_blank" rel="noopener noreferrer">Young Survival Coalition</a></li>
            </ul>
          </div>

          <p class="mt-6 text-sm italic text-gray-500">
            We encourage you to explore these trusted sources for support, education, and connection throughout your journey.
          </p>
        </div>

        <!-- Important Dates Tab -->
        <div id="important-dates-tab" class="tab-content">
          <h2 class="text-xl font-bold mb-4">Important Dates</h2>
          <div
            class="p-8 text-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
            <i class="fas fa-tools text-4xl text-gray-400 mb-3"></i>
            
          </div>
        </div>

        <!-- Matches Tab -->
        <div id="matches-tab" class="tab-content">
          <h2 class="text-xl font-bold mb-4">Your Matches</h2>
          <div id="matches-list" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loading" class="loading hidden">
    <div
      class="bg-white p-5 rounded-lg shadow-lg flex items-center"
    >
      <svg
        class="spinner w-6 h-6 text-blue-500 mr-3"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      <span>Loading...</span>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config - REPLACE WITH YOUR OWN
    const firebaseConfig = {
        apiKey: "AIzaSyBkhJA-hpp7Rj_2CfK5CXiMZ2mKr3t0AMw",
        authDomain: "hope-s-compass.firebaseapp.com",
        databaseURL: "https://hope-s-compass-default-rtdb.firebaseio.com",
        projectId: "hope-s-compass",
        storageBucket: "hope-s-compass.firebasestorage.app",
        messagingSenderId: "663262130072",
        appId: "1:663262130072:web:8c2c075238124ae4a8c5ed",
        measurementId: "G-YFHTEYRKZD"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Elements
    const authCard = document.getElementById('auth-card');
    const onboardingCard = document.getElementById('onboarding-card');
    const portal = document.getElementById('portal');
    const loading = document.getElementById('loading');

    // Auth Tabs & Forms
    const signinTab = document.getElementById('signin-tab');
    const signupTab = document.getElementById('signup-tab');
    const signinForm = document.getElementById('signin-form');
    const signupForm = document.getElementById('signup-form');

    // Onboarding form
    const onboardingForm = document.getElementById('onboarding-form');

    // Portal UI
    const logoutBtn = document.getElementById('logout-btn');
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const tabContents = Array.from(document.querySelectorAll('.tab-content'));

    // Profile fields
    const profileEmail = document.getElementById('profile-email');
    const profileRole = document.getElementById('profile-role');
    const profileAge = document.getElementById('profile-age');
    const profileCancerType = document.getElementById('profile-cancer-type');
    const profileTreatmentStage = document.getElementById('profile-treatment-stage');
    const profileInterests = document.getElementById('profile-interests');

    // Chat elements
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatHistory = document.getElementById('chat-history');

    // Matches list
    const matchesList = document.getElementById('matches-list');

    // Helpers
    function showLoading() {
      loading.classList.remove('hidden');
    }
    function hideLoading() {
      loading.classList.add('hidden');
    }
    function showError(input, message) {
      const p = input.parentElement.querySelector('.error-message');
      if (p) {
        p.textContent = message;
        p.classList.remove('hidden');
      }
    }
    function clearErrors(form) {
      form.querySelectorAll('.error-message').forEach(el => {
        el.textContent = '';
        el.classList.add('hidden');
      });
    }
    function formatTreatmentStage(stage) {
      if (!stage) return '';
      const stages = {
        'newly-diagnosed': 'Newly Diagnosed',
        'active-treatment': 'Active Treatment',
        'post-treatment': 'Post Treatment',
        remission: 'Remission'
      };
      return stages[stage] || stage;
    }

    // Switch auth tabs
    function switchAuthTab(tab) {
      if (tab === 'signin') {
        signinTab.classList.add('border-blue-500', 'text-gray-700');
        signinTab.classList.remove('text-gray-500');
        signupTab.classList.remove('border-blue-500', 'text-gray-700');
        signupTab.classList.add('text-gray-500');
        signinForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
      } else {
        signupTab.classList.add('border-blue-500', 'text-gray-700');
        signupTab.classList.remove('text-gray-500');
        signinTab.classList.remove('border-blue-500', 'text-gray-700');
        signinTab.classList.add('text-gray-500');
        signupForm.classList.remove('hidden');
        signinForm.classList.add('hidden');
      }
      clearErrors(signinForm);
      clearErrors(signupForm);
    }

    signinTab.addEventListener('click', () => switchAuthTab('signin'));
    signupTab.addEventListener('click', () => switchAuthTab('signup'));

    // Sign Up
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors(signupForm);

      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      const role = document.getElementById('role').value;

      let valid = true;

      if (!email) {
        showError(document.getElementById('signup-email'), 'Email is required');
        valid = false;
      }
      if (!password || password.length < 6) {
        showError(document.getElementById('signup-password'), 'Password must be at least 6 characters');
        valid = false;
      }
      if (!role) {
        showError(document.getElementById('role'), 'Please select a role');
        valid = false;
      }

      if (!valid) return;

      try {
        showLoading();
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Create Firestore user doc
        await db.collection('users').doc(user.uid).set({
          email,
          role,
          isOnboarded: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        onboardingCard.classList.remove('hidden');
        authCard.classList.add('hidden');
      } catch (error) {
        alert('Sign up error: ' + error.message);
      } finally {
        hideLoading();
      }
    });

    // Sign In
    signinForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors(signinForm);

      const email = document.getElementById('signin-email').value.trim();
      const password = document.getElementById('signin-password').value;

      let valid = true;
      if (!email) {
        showError(document.getElementById('signin-email'), 'Email is required');
        valid = false;
      }
      if (!password) {
        showError(document.getElementById('signin-password'), 'Password is required');
        valid = false;
      }
      if (!valid) return;

      try {
        showLoading();
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Load user doc from Firestore
        const userDoc = await db.collection('users').doc(user.uid).get();
        const userData = userDoc.data();

        if (!userData || !userData.isOnboarded) {
          onboardingCard.classList.remove('hidden');
          authCard.classList.add('hidden');
        } else {
          portal.classList.remove('hidden');
          authCard.classList.add('hidden');
          updateProfileUI(userData);
          loadMatches(userData);
        }
      } catch (error) {
        alert('Sign in error: ' + error.message);
      } finally {
        hideLoading();
      }
    });

    // Onboarding
    onboardingForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors(onboardingForm);

      const ageInput = document.getElementById('age');
      const cancerTypeInput = document.getElementById('cancer-type');
      const treatmentStageInput = document.getElementById('treatment-stage');
      const interestsInput = document.getElementById('interests');

      let valid = true;
      if (!ageInput.value) {
        showError(ageInput, 'Age must be valid.');
        valid = false;
      }
      if (!cancerTypeInput.value.trim()) {
        showError(cancerTypeInput, 'Cancer type is required');
        valid = false;
      }
      if (!treatmentStageInput.value) {
        showError(treatmentStageInput, 'Select treatment stage');
        valid = false;
      }
      if (!interestsInput.value.trim()) {
        showError(interestsInput, 'Please enter at least one interest');
        valid = false;
      }
      if (!valid) return;

      try {
        showLoading();
        const user = auth.currentUser;
        if (!user) throw new Error('Not authenticated');

        const userDocRef = db.collection('users').doc(user.uid);

        await userDocRef.update({
          age: Number(ageInput.value),
          cancerType: cancerTypeInput.value.trim(),
          treatmentStage: treatmentStageInput.value,
          interests: interestsInput.value.trim(),
          isOnboarded: true,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Reload updated data
        const updatedUserDoc = await userDocRef.get();
        const updatedUserData = updatedUserDoc.data();

        onboardingCard.classList.add('hidden');
        portal.classList.remove('hidden');
        updateProfileUI(updatedUserData);
        loadMatches(updatedUserData);
      } catch (error) {
        alert('Error updating profile: ' + error.message);
      } finally {
        hideLoading();
      }
    });

    // Update Profile UI
    function updateProfileUI(user) {
      profileEmail.textContent = user.email || '';
      profileRole.textContent = user.role === 'mentor' ? 'Mentor' : 'Mentee';
      profileAge.textContent = user.age || '';
      profileCancerType.textContent = user.cancerType || '';
      profileTreatmentStage.textContent = formatTreatmentStage(user.treatmentStage) || '';
      profileInterests.textContent = user.interests || '';
    }
    function loadConnectionRequests() {
        const currentUser = auth.currentUser;
        if (!currentUser) return;

        const requestsContainer = document.createElement('div');
        requestsContainer.id = 'connection-requests';
        requestsContainer.className = 'mb-4 p-4 bg-yellow-50 border border-yellow-300 rounded';

        const requestsTitle = document.createElement('h3');
        requestsTitle.textContent = 'Connection Requests';
        requestsTitle.className = 'text-lg font-bold mb-2';
        requestsContainer.appendChild(requestsTitle);

        const requestsList = document.createElement('div');
        requestsContainer.appendChild(requestsList);

        db.collection('connectionRequests')
        .where('toUserId', '==', currentUser.uid)
        .where('status', '==', 'pending')
        .onSnapshot(async snapshot => {
        requestsList.innerHTML = '';
      if (snapshot.empty) {
        requestsList.innerHTML = '<p class="text-gray-600">No pending requests.</p>';
        return;
      }

      for (const docSnap of snapshot.docs) {
        const req = docSnap.data();
        const senderDoc = await db.collection('users').doc(req.fromUserId).get();
        const sender = senderDoc.data();

        const requestDiv = document.createElement('div');
        requestDiv.className = 'p-3 mb-2 bg-white border rounded shadow-sm';
        requestDiv.innerHTML = `
          <p><strong>${sender.email}</strong> (${sender.role}) wants to connect.</p>
          <button class="accept-btn bg-green-500 text-white px-3 py-1 rounded mt-2" data-id="${docSnap.id}">Accept</button>
          <button class="decline-btn bg-red-500 text-white px-3 py-1 rounded mt-2 ml-2" data-id="${docSnap.id}">Decline</button>
        `;
        requestsList.appendChild(requestDiv);
      }

      requestsList.querySelectorAll('.accept-btn').forEach(btn => {
        btn.addEventListener('click', () => updateRequestStatus(btn.dataset.id, 'accepted'));
      });

      requestsList.querySelectorAll('.decline-btn').forEach(btn => {
        btn.addEventListener('click', () => updateRequestStatus(btn.dataset.id, 'declined'));
      });
    });

  const profileTab = document.getElementById('profile-tab');
  profileTab.insertBefore(requestsContainer, profileTab.firstChild);
}

async function updateRequestStatus(requestId, newStatus) {
  try {
    await db.collection('connectionRequests').doc(requestId).update({
      status: newStatus,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert(`Request ${newStatus}`);
  } catch (err) {
    alert('Error updating request: ' + err.message);
  }
}


    // Tab navigation
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active', 'text-blue-600'));
        tab.classList.add('active', 'text-blue-600');

        const tabId = tab.getAttribute('data-tab');
        tabContents.forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabId}-tab`).classList.add('active');

        // Load matches tab dynamically on open
        if (tabId === 'matches') {
          loadMatches();
        }
      });
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      await auth.signOut();
      portal.classList.add('hidden');
      onboardingCard.classList.add('hidden');
      authCard.classList.remove('hidden');
      switchAuthTab('signin');
      // Clear all forms
      document.querySelectorAll('form').forEach(form => form.reset());
      chatHistory.innerHTML = '';
      matchesList.innerHTML = '';
    });

    // Chat form (prototype)
    chatForm.addEventListener('submit', e => {
      e.preventDefault();
      const message = chatInput.value.trim();
      if (!message) return;
      appendMessage('You', message, 'sent');
      chatInput.value = '';
      setTimeout(() => {
        appendMessage('Mentor', 'Test.', 'received');
      }, 1000);
    });

    function appendMessage(sender, text, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${type} p-3`;

      const header = document.createElement('div');
      header.className = 'flex justify-between items-center mb-1';

      const senderSpan = document.createElement('span');
      senderSpan.className = 'font-medium';
      senderSpan.textContent = sender;

      const timestamp = document.createElement('span');
      timestamp.className = 'text-xs opacity-70';
      timestamp.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      header.appendChild(senderSpan);
      header.appendChild(timestamp);

      const messageText = document.createElement('div');
      messageText.textContent = text;

      messageDiv.appendChild(header);
      messageDiv.appendChild(messageText);

      chatHistory.appendChild(messageDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // Load matches tab content
    async function loadMatches(currentUserData = null) {
      if (!currentUserData) {
        // Get current user data from Firestore
        const user = auth.currentUser;
        if (!user) return;
        const doc = await db.collection('users').doc(user.uid).get();
        currentUserData = doc.data();
      }
      matchesList.innerHTML = '<p>Loading matches...</p>';

      try {
        const oppositeRole = currentUserData.role === 'mentor' ? 'mentee' : 'mentor';
        const userInterests = currentUserData.interests
          ? currentUserData.interests.toLowerCase().split(',').map(i => i.trim())
          : [];

        const usersSnapshot = await db.collection('users')
          .where('role', '==', oppositeRole)
          .where('isOnboarded', '==', true)
          .get();

        const matches = [];

        usersSnapshot.forEach(doc => {
          const data = doc.data();
          if (!data.cancerType || !data.interests) return;

          if (data.cancerType.toLowerCase() === currentUserData.cancerType.toLowerCase()) {
            const theirInterests = data.interests.toLowerCase().split(',').map(i => i.trim());
            const sharedInterests = userInterests.filter(i => theirInterests.includes(i));

            if (sharedInterests.length > 0) {
              matches.push({
                id: doc.id,
                email: data.email,
                role: data.role,
                cancerType: data.cancerType,
                treatmentStage: data.treatmentStage,
                interests: data.interests,
                sharedInterests
              });
            }
          }
        });

        if (matches.length === 0) {
          matchesList.innerHTML = '<p>No matches found yet. Try updating your interests or profile.</p>';
          return;
        }

        matchesList.innerHTML = '';
        matches.forEach(match => {
          const div = document.createElement('div');
          div.className = 'p-4 bg-gray-50 rounded shadow';

          div.innerHTML = `
            <p><strong>Email:</strong> ${match.email}</p>
            <p><strong>Role:</strong> ${match.role === 'mentor' ? 'Mentor' : 'Mentee'}</p>
            <p><strong>Cancer Type:</strong> ${match.cancerType}</p>
            <p><strong>Treatment Stage:</strong> ${formatTreatmentStage(match.treatmentStage)}</p>
            <p><strong>Shared Interests:</strong> ${match.sharedInterests.join(', ')}</p>
            <button class="connect-btn mt-2 px-4 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded transition duration-200" data-id="${match.id}">Connect</button>
          `;

          matchesList.appendChild(div);
        });

        // Add connect button handlers (prototype - just alert)
        // Add connect button handlers (save to Firestore)
        matchesList.querySelectorAll('.connect-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
        const targetUserId = btn.getAttribute('data-id');
        const currentUser = auth.currentUser;

        if (!currentUser) {
            alert('You must be signed in to send a connection request.');
            return;
        }

        try {
            showLoading();

            await db.collection('connectionRequests').add({
            fromUserId: currentUser.uid,
            toUserId: targetUserId,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('Connection request sent!');
    } catch (err) {
        alert('Error sending request: ' + err.message);
    } finally {
          hideLoading();
        }
      });
    });

      } catch (error) {
        matchesList.innerHTML = `<p class="text-red-500">Error loading matches: ${error.message}</p>`;
      }
    }

    // Monitor auth state on page load
    auth.onAuthStateChanged(async (user) => {
  if (user) {
    try {
      const userDocRef = db.collection('users').doc(user.uid);
      const docSnap = await userDocRef.get();

      if (!docSnap.exists) {
        console.log("No user document found â€” redirecting to onboarding.");
        showOnboarding(user); // or create a blank profile
        return;
      }

      const userData = docSnap.data();

      if (!userData.isOnboarded) {
        showOnboarding(user);
        return;
      }

      updateProfileUI(userData);
      loadMatches(userData);
      loadConnectionRequests(); // safe to call now

    } catch (err) {
      console.error("Error loading user data:", err);
    }
  } else {
    // handle signed-out state
  }
});

  </script>
</body>
</html>
